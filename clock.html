<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clock & Calendar</title>
    <style>
        body {
            background-color: white;
            color: black;
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        #clockWeather {
            position: absolute;
        }
        #clock {
            position: relative;
            font-size: 12vw;
            font-weight: bold;
            z-index: 1;
        }
        #weather {
            position: relative;
            font-size: 18px;
            text-align: center;
            margin-top: 5px;
        }
        #calendar {
            position: absolute;
            font-size: 3vw;
            z-index: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        td {
            padding: 5px;
            text-align: center;
            font-size: 3vw;
        }
        .highlight {
            background-color: black;
            color: white;
            font-weight: bold;
            border-radius: 5px;
        }
        .weekday-header {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        .current-day {
            background-color: #FFD700;
            color: black;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="clockWeather">
        <div id="clock"></div>
        <div id="weather"></div>
    </div>
    <div id="calendar"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const cityParam = urlParams.get("city"); // https://lbs.amap.com/api/webservice/download ä¸­åŸå¸‚ç¼–ç  adcode
        const keyParam = urlParams.get("key");
        let city = "440305"; // 110000 åŒ—äº¬ 110108 æµ·æ·€åŒº 310000 ä¸Šæµ· 310115 æµ¦ä¸œæ–°åŒº 440100 å¹¿å· 440106 å¤©æ²³åŒº 440300 æ·±åœ³ 440305 å—å±±åŒº
        let key = "<æ›¿æ¢ä¸ºçœŸæ­£çš„ç”¨æˆ·keyæˆ–é€šè¿‡å‚æ•°ä¼ å…¥>";
        if (cityParam) {
            city = cityParam;
        }
        if (keyParam) {
            key = keyParam;
        }
        async function fetchWeather() {
            if (city === "auto") {
                try {
                    // ä½¿ç”¨é«˜å¾·åœ°å›¾APIè·å–åœ°ç†ä½ç½®
                    const response = await fetch(`https://restapi.amap.com/v3/ip?output=JSON&key=${key}`);
                    const data = await response.json();

                    if (data.status === "1") {
                        city = data.adcode;
                    }
                } catch (error) {
                    console.log("å®šä½å¤±è´¥");
                }
            }

            try {
                // ä½¿ç”¨é«˜å¾·åœ°å›¾APIè·å–å¤©æ°”ä¿¡æ¯
                const response = await fetch(`https://restapi.amap.com/v3/weather/weatherInfo?city=${city}&extensions=all&output=JSON&key=${key}`);
                const data = await response.json();

                const weatherElement = document.getElementById("weather");
                weatherElement.children = [];

                if (data.status === "1" && data.forecasts.length > 0) {

                    const forecast = data.forecasts[0];
                    const city = `${forecast.province} ${forecast.city}`;

                    const title = document.createElement("p");
                    title.innerText = `ğŸ“ ${city} å¤©æ°”é¢„æŠ¥ (${forecast.reporttime})`;
                    weatherElement.appendChild(title);

                    forecast.casts.forEach((day, index) => {
                        const weather = document.createElement("p");
                        const label = index === 0 ? "ä»Šå¤©" : `æ˜ŸæœŸ${day.week}`;
                        weather.innerText = `ğŸ“… ${label} ${day.date} | ${day.dayweather} | ğŸŒ¡ï¸ ${day.daytemp}Â°C / ${day.nighttemp}Â°C | ğŸ’¨ ${day.daywind} ${day.daypower}çº§`;
                        weatherElement.appendChild(weather);
                    });
                } else {
                    weatherElement.innerText = "æ— æ³•è·å–å¤©æ°”æ•°æ®";
                }
            } catch (error) {
                document.getElementById("weather").innerText = "å¤©æ°”è·å–å¤±è´¥";
            }

            updateClock();
        }

        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById("clock").innerText = `${hours}:${minutes}`;

            generateCalendar(now.getFullYear(), now.getMonth() + 1, now.getDate(), now.getDay());
            moveElementsRandomly(); // è¿›è¡Œéšæœºåç§»
        }

        function generateCalendar(year, month, today, currentWeekday) {
            const firstDay = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();

            const calendarContainer = document.getElementById("calendar");
            calendarContainer.innerHTML = ""; // æ¸…ç©ºå½“å‰å†…å®¹

            // åˆ›å»ºæ ‡é¢˜
            const title = document.createElement("h2");
            title.innerText = `ğŸ“… ${year}å¹´${month}æœˆ`;
            calendarContainer.appendChild(title);

            // åˆ›å»ºè¡¨æ ¼
            const table = document.createElement("table");

            // åˆ›å»ºæ˜ŸæœŸæ 
            const headerRow = document.createElement("tr");
            const daysOfWeek = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];

            // æ˜ŸæœŸè¡ŒåŠ ç‰¹æ®ŠèƒŒæ™¯é¢œè‰²
            daysOfWeek.forEach((day, index) => {
                const th = document.createElement("td");
                th.innerText = day;
                th.classList.add("weekday-header");
                if (index === currentWeekday) {
                    th.classList.add("current-day"); // å½“å‰æ˜ŸæœŸå‡ ç‰¹æ®Šæ ‡è®°
                }
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            let day = 1;
            // ç¬¬ä¸€è¡Œï¼ˆåŒ…å«ç©ºç™½ï¼‰
            const firstRow = document.createElement("tr");
            for (let i = 0; i < 7; i++) {
                const td = document.createElement("td");
                if (i < firstDay) {
                    firstRow.appendChild(td); // ç©ºç™½æ ¼
                } else {
                    td.innerText = day;
                    if (day === today) {
                        td.classList.add("highlight");
                    }
                    firstRow.appendChild(td);
                    day++;
                }
            }
            table.appendChild(firstRow);

            // å…¶ä»–è¡Œï¼ˆå¡«å……æ—¥æœŸï¼‰
            while (day <= daysInMonth) {
                const row = document.createElement("tr");
                for (let i = 0; i < 7; i++) {
                    const td = document.createElement("td");
                    if (day <= daysInMonth) {
                        td.innerText = day;
                        if (day === today) {
                            td.classList.add("highlight");
                        }
                        day++;
                    }
                    row.appendChild(td);
                }
                table.appendChild(row);
            }

            calendarContainer.appendChild(table);
        }

        function moveElementsRandomly() {
            const clock = document.getElementById("clockWeather");
            const calendar = document.getElementById("calendar");

            const clockWidth = clock.offsetWidth;
            const clockHeight = clock.offsetHeight;
            const calendarWidth = calendar.offsetWidth;
            const calendarHeight = calendar.offsetHeight;

            console.log(clockWidth, clockHeight, calendarWidth, calendarHeight);

            let clockX, clockY;

            // 1. æ‰§è¡Œæ—¶é’Ÿçš„éšæœºåç§»ï¼Œç¡®ä¿èƒ½å¤Ÿå®Œæ•´æ˜¾ç¤º
            const clockMaxX = window.innerWidth - clockWidth - 50;
            const clockMaxY = window.innerHeight - clockHeight - 50;
            clockX = Math.random() * clockMaxX + 25;
            clockY = Math.random() * clockMaxY + 25;
            clockX = Math.max(clockX, 0);
            clockY = Math.max(clockY, 0);

            // è®¾ç½®æ—¶é’Ÿä½ç½®
            clock.style.left = `${clockX}px`;
            clock.style.top = `${clockY}px`;

            // 2. è®¡ç®—æ—¶é’Ÿå·¦æ–¹ã€å³æ–¹ã€ä¸Šæ–¹ã€ä¸‹æ–¹çš„å‰©ä½™ç©ºé—´
            const leftSpace = clockX;
            const rightSpace = window.innerWidth - (clockX + clockWidth);
            const topSpace = clockY;
            const bottomSpace = window.innerHeight - (clockY + clockHeight);

            // 3. ç¡®å®šå“ªä¸ªåŒºåŸŸç©ºé—´æœ€å¤§
            let maxSpaceX, maxSpaceY, calendarX, calendarY;
            let left = 0, top = 0;

            if (leftSpace >= rightSpace && leftSpace >= topSpace && leftSpace >= bottomSpace) {
                maxSpaceX = leftSpace - calendarWidth - 50;
                maxSpaceY = window.innerHeight - calendarHeight - 50
            } else if (rightSpace >= leftSpace && rightSpace >= topSpace && rightSpace >= bottomSpace) {
                maxSpaceX = rightSpace - calendarWidth - 50;
                maxSpaceY = window.innerHeight - calendarHeight - 50
                left = clockX + clockWidth;
            } else if (topSpace >= leftSpace && topSpace >= rightSpace && topSpace >= bottomSpace) {
                maxSpaceX = window.innerWidth - calendarWidth - 50;
                maxSpaceY = topSpace - calendarHeight - 50;
            } else {
                maxSpaceX = window.innerWidth - calendarWidth - 50;
                maxSpaceY = bottomSpace - calendarHeight - 50;
                top = clockY + clockHeight;
            }

            // åœ¨æœ€å¤§ç©ºé—´å†…è¿›è¡Œéšæœºåç§»ï¼Œç¡®ä¿æœˆå†æ˜¾ç¤ºå®Œæ•´
            calendarX = Math.random() * maxSpaceX + left + 25;
            calendarY = Math.random() * maxSpaceY + top + 25;
            calendarX = Math.max(calendarX, 0);
            calendarY = Math.max(calendarY, 0);

            // è®¾ç½®æœˆå†ä½ç½®
            calendar.style.left = `${calendarX}px`;
            calendar.style.top = `${calendarY}px`;
        }

        fetchWeather();
        // updateClock();
        setInterval(updateClock, 60000); // æ¯åˆ†é’Ÿæ›´æ–°æ—¶é—´
        setInterval(fetchWeather, 3600000); // æ¯å°æ—¶æ›´æ–°å¤©æ°”
    </script>
</body>
</html>
